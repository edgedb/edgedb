name: Package Build Dry Run

on:
  workflow_dispatch:
    inputs: {}

jobs:
  prep:
    runs-on: ubuntu-latest

    outputs:

      if_linux_aarch64_00: ${{ steps.scm.outputs.if_linux_aarch64_00 }}

      if_linux_aarch64_01: ${{ steps.scm.outputs.if_linux_aarch64_01 }}

      if_linux_aarch64_02: ${{ steps.scm.outputs.if_linux_aarch64_02 }}

      if_linux_aarch64_03: ${{ steps.scm.outputs.if_linux_aarch64_03 }}

      if_linux_aarch64_04: ${{ steps.scm.outputs.if_linux_aarch64_04 }}

      if_linux_aarch64_05: ${{ steps.scm.outputs.if_linux_aarch64_05 }}

      if_linux_aarch64_06: ${{ steps.scm.outputs.if_linux_aarch64_06 }}

      if_linux_aarch64_07: ${{ steps.scm.outputs.if_linux_aarch64_07 }}

      if_linux_aarch64_08: ${{ steps.scm.outputs.if_linux_aarch64_08 }}

      if_linux_aarch64_09: ${{ steps.scm.outputs.if_linux_aarch64_09 }}


    steps:
    - uses: actions/checkout@v4


    - name: Determine SCM revision
      id: scm
      shell: bash
      run: |
        rev=$(git rev-parse HEAD)
        jq_filter='.packages[] | select(.basename == "edgedb-server") | select(.architecture == $ARCH) | .version_details.metadata.scm_revision | . as $rev | select(($rev != null) and ($REV | startswith($rev)))'

        val=true

        out=$(curl --fail -s https://packages.edgedb.com/archive/.jsonindexes/aarch64-unknown-linux-gnu.nightly.json | jq -r --arg REV "$rev" --arg ARCH "aarch64" "$jq_filter" || true)
        if [ -n "$out" ]; then
          echo 'Skip rebuilding existing linux-aarch64-00'
          val=false
        fi

        echo if_linux_aarch64_00="$val" >> $GITHUB_OUTPUT

        val=true

        out=$(curl --fail -s https://packages.edgedb.com/archive/.jsonindexes/aarch64-unknown-linux-gnu.nightly.json | jq -r --arg REV "$rev" --arg ARCH "aarch64" "$jq_filter" || true)
        if [ -n "$out" ]; then
          echo 'Skip rebuilding existing linux-aarch64-01'
          val=false
        fi

        echo if_linux_aarch64_01="$val" >> $GITHUB_OUTPUT

        val=true

        out=$(curl --fail -s https://packages.edgedb.com/archive/.jsonindexes/aarch64-unknown-linux-gnu.nightly.json | jq -r --arg REV "$rev" --arg ARCH "aarch64" "$jq_filter" || true)
        if [ -n "$out" ]; then
          echo 'Skip rebuilding existing linux-aarch64-02'
          val=false
        fi

        echo if_linux_aarch64_02="$val" >> $GITHUB_OUTPUT

        val=true

        out=$(curl --fail -s https://packages.edgedb.com/archive/.jsonindexes/aarch64-unknown-linux-gnu.nightly.json | jq -r --arg REV "$rev" --arg ARCH "aarch64" "$jq_filter" || true)
        if [ -n "$out" ]; then
          echo 'Skip rebuilding existing linux-aarch64-03'
          val=false
        fi

        echo if_linux_aarch64_03="$val" >> $GITHUB_OUTPUT

        val=true

        out=$(curl --fail -s https://packages.edgedb.com/archive/.jsonindexes/aarch64-unknown-linux-gnu.nightly.json | jq -r --arg REV "$rev" --arg ARCH "aarch64" "$jq_filter" || true)
        if [ -n "$out" ]; then
          echo 'Skip rebuilding existing linux-aarch64-04'
          val=false
        fi

        echo if_linux_aarch64_04="$val" >> $GITHUB_OUTPUT

        val=true

        out=$(curl --fail -s https://packages.edgedb.com/archive/.jsonindexes/aarch64-unknown-linux-gnu.nightly.json | jq -r --arg REV "$rev" --arg ARCH "aarch64" "$jq_filter" || true)
        if [ -n "$out" ]; then
          echo 'Skip rebuilding existing linux-aarch64-05'
          val=false
        fi

        echo if_linux_aarch64_05="$val" >> $GITHUB_OUTPUT

        val=true

        out=$(curl --fail -s https://packages.edgedb.com/archive/.jsonindexes/aarch64-unknown-linux-gnu.nightly.json | jq -r --arg REV "$rev" --arg ARCH "aarch64" "$jq_filter" || true)
        if [ -n "$out" ]; then
          echo 'Skip rebuilding existing linux-aarch64-06'
          val=false
        fi

        echo if_linux_aarch64_06="$val" >> $GITHUB_OUTPUT

        val=true

        out=$(curl --fail -s https://packages.edgedb.com/archive/.jsonindexes/aarch64-unknown-linux-gnu.nightly.json | jq -r --arg REV "$rev" --arg ARCH "aarch64" "$jq_filter" || true)
        if [ -n "$out" ]; then
          echo 'Skip rebuilding existing linux-aarch64-07'
          val=false
        fi

        echo if_linux_aarch64_07="$val" >> $GITHUB_OUTPUT

        val=true

        out=$(curl --fail -s https://packages.edgedb.com/archive/.jsonindexes/aarch64-unknown-linux-gnu.nightly.json | jq -r --arg REV "$rev" --arg ARCH "aarch64" "$jq_filter" || true)
        if [ -n "$out" ]; then
          echo 'Skip rebuilding existing linux-aarch64-08'
          val=false
        fi

        echo if_linux_aarch64_08="$val" >> $GITHUB_OUTPUT

        val=true

        out=$(curl --fail -s https://packages.edgedb.com/archive/.jsonindexes/aarch64-unknown-linux-gnu.nightly.json | jq -r --arg REV "$rev" --arg ARCH "aarch64" "$jq_filter" || true)
        if [ -n "$out" ]; then
          echo 'Skip rebuilding existing linux-aarch64-09'
          val=false
        fi

        echo if_linux_aarch64_09="$val" >> $GITHUB_OUTPUT




  build-linux-aarch64-00:
    runs-on: ['package-builder', 'self-hosted', 'linux', 'arm64']
    needs: prep

    if: needs.prep.outputs.if_linux_aarch64_00 == 'true'


    steps:
    - name: Build
      uses: edgedb/edgedb-pkg/integration/linux/build/linux-aarch64@master
      env:
        SRC_REF: "${{ github.sha }}"
        PKG_REVISION: "<current-date>"
        PKG_SUBDIST: "nightly"
        PKG_PLATFORM: "linux"
        PKG_PLATFORM_VERSION: "aarch64"
        EXTRA_OPTIMIZATIONS: "true"
        BUILD_GENERIC: true
        METAPKG_GIT_CACHE: disabled

    - uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874  # v4.4.0
      with:
        name: builds-linux-aarch64-00
        path: artifacts/linux-aarch64

  build-linux-aarch64-01:
    runs-on: ['package-builder', 'self-hosted', 'linux', 'arm64']
    needs: prep

    if: needs.prep.outputs.if_linux_aarch64_01 == 'true'


    steps:
    - name: Build
      uses: edgedb/edgedb-pkg/integration/linux/build/linux-aarch64@master
      env:
        SRC_REF: "${{ github.sha }}"
        PKG_REVISION: "<current-date>"
        PKG_SUBDIST: "nightly"
        PKG_PLATFORM: "linux"
        PKG_PLATFORM_VERSION: "aarch64"
        EXTRA_OPTIMIZATIONS: "true"
        BUILD_GENERIC: true
        METAPKG_GIT_CACHE: disabled

    - uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874  # v4.4.0
      with:
        name: builds-linux-aarch64-01
        path: artifacts/linux-aarch64

  build-linux-aarch64-02:
    runs-on: ['package-builder', 'self-hosted', 'linux', 'arm64']
    needs: prep

    if: needs.prep.outputs.if_linux_aarch64_02 == 'true'


    steps:
    - name: Build
      uses: edgedb/edgedb-pkg/integration/linux/build/linux-aarch64@master
      env:
        SRC_REF: "${{ github.sha }}"
        PKG_REVISION: "<current-date>"
        PKG_SUBDIST: "nightly"
        PKG_PLATFORM: "linux"
        PKG_PLATFORM_VERSION: "aarch64"
        EXTRA_OPTIMIZATIONS: "true"
        BUILD_GENERIC: true
        METAPKG_GIT_CACHE: disabled

    - uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874  # v4.4.0
      with:
        name: builds-linux-aarch64-02
        path: artifacts/linux-aarch64

  build-linux-aarch64-03:
    runs-on: ['package-builder', 'self-hosted', 'linux', 'arm64']
    needs: prep

    if: needs.prep.outputs.if_linux_aarch64_03 == 'true'


    steps:
    - name: Build
      uses: edgedb/edgedb-pkg/integration/linux/build/linux-aarch64@master
      env:
        SRC_REF: "${{ github.sha }}"
        PKG_REVISION: "<current-date>"
        PKG_SUBDIST: "nightly"
        PKG_PLATFORM: "linux"
        PKG_PLATFORM_VERSION: "aarch64"
        EXTRA_OPTIMIZATIONS: "true"
        BUILD_GENERIC: true
        METAPKG_GIT_CACHE: disabled

    - uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874  # v4.4.0
      with:
        name: builds-linux-aarch64-03
        path: artifacts/linux-aarch64

  build-linux-aarch64-04:
    runs-on: ['package-builder', 'self-hosted', 'linux', 'arm64']
    needs: prep

    if: needs.prep.outputs.if_linux_aarch64_04 == 'true'


    steps:
    - name: Build
      uses: edgedb/edgedb-pkg/integration/linux/build/linux-aarch64@master
      env:
        SRC_REF: "${{ github.sha }}"
        PKG_REVISION: "<current-date>"
        PKG_SUBDIST: "nightly"
        PKG_PLATFORM: "linux"
        PKG_PLATFORM_VERSION: "aarch64"
        EXTRA_OPTIMIZATIONS: "true"
        BUILD_GENERIC: true
        METAPKG_GIT_CACHE: disabled

    - uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874  # v4.4.0
      with:
        name: builds-linux-aarch64-04
        path: artifacts/linux-aarch64

  build-linux-aarch64-05:
    runs-on: ['package-builder', 'self-hosted', 'linux', 'arm64']
    needs: prep

    if: needs.prep.outputs.if_linux_aarch64_05 == 'true'


    steps:
    - name: Build
      uses: edgedb/edgedb-pkg/integration/linux/build/linux-aarch64@master
      env:
        SRC_REF: "${{ github.sha }}"
        PKG_REVISION: "<current-date>"
        PKG_SUBDIST: "nightly"
        PKG_PLATFORM: "linux"
        PKG_PLATFORM_VERSION: "aarch64"
        EXTRA_OPTIMIZATIONS: "true"
        BUILD_GENERIC: true
        METAPKG_GIT_CACHE: disabled

    - uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874  # v4.4.0
      with:
        name: builds-linux-aarch64-05
        path: artifacts/linux-aarch64

  build-linux-aarch64-06:
    runs-on: ['package-builder', 'self-hosted', 'linux', 'arm64']
    needs: prep

    if: needs.prep.outputs.if_linux_aarch64_06 == 'true'


    steps:
    - name: Build
      uses: edgedb/edgedb-pkg/integration/linux/build/linux-aarch64@master
      env:
        SRC_REF: "${{ github.sha }}"
        PKG_REVISION: "<current-date>"
        PKG_SUBDIST: "nightly"
        PKG_PLATFORM: "linux"
        PKG_PLATFORM_VERSION: "aarch64"
        EXTRA_OPTIMIZATIONS: "true"
        BUILD_GENERIC: true
        METAPKG_GIT_CACHE: disabled

    - uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874  # v4.4.0
      with:
        name: builds-linux-aarch64-06
        path: artifacts/linux-aarch64

  build-linux-aarch64-07:
    runs-on: ['package-builder', 'self-hosted', 'linux', 'arm64']
    needs: prep

    if: needs.prep.outputs.if_linux_aarch64_07 == 'true'


    steps:
    - name: Build
      uses: edgedb/edgedb-pkg/integration/linux/build/linux-aarch64@master
      env:
        SRC_REF: "${{ github.sha }}"
        PKG_REVISION: "<current-date>"
        PKG_SUBDIST: "nightly"
        PKG_PLATFORM: "linux"
        PKG_PLATFORM_VERSION: "aarch64"
        EXTRA_OPTIMIZATIONS: "true"
        BUILD_GENERIC: true
        METAPKG_GIT_CACHE: disabled

    - uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874  # v4.4.0
      with:
        name: builds-linux-aarch64-07
        path: artifacts/linux-aarch64

  build-linux-aarch64-08:
    runs-on: ['package-builder', 'self-hosted', 'linux', 'arm64']
    needs: prep

    if: needs.prep.outputs.if_linux_aarch64_08 == 'true'


    steps:
    - name: Build
      uses: edgedb/edgedb-pkg/integration/linux/build/linux-aarch64@master
      env:
        SRC_REF: "${{ github.sha }}"
        PKG_REVISION: "<current-date>"
        PKG_SUBDIST: "nightly"
        PKG_PLATFORM: "linux"
        PKG_PLATFORM_VERSION: "aarch64"
        EXTRA_OPTIMIZATIONS: "true"
        BUILD_GENERIC: true
        METAPKG_GIT_CACHE: disabled

    - uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874  # v4.4.0
      with:
        name: builds-linux-aarch64-08
        path: artifacts/linux-aarch64

  build-linux-aarch64-09:
    runs-on: ['package-builder', 'self-hosted', 'linux', 'arm64']
    needs: prep

    if: needs.prep.outputs.if_linux_aarch64_09 == 'true'


    steps:
    - name: Build
      uses: edgedb/edgedb-pkg/integration/linux/build/linux-aarch64@master
      env:
        SRC_REF: "${{ github.sha }}"
        PKG_REVISION: "<current-date>"
        PKG_SUBDIST: "nightly"
        PKG_PLATFORM: "linux"
        PKG_PLATFORM_VERSION: "aarch64"
        EXTRA_OPTIMIZATIONS: "true"
        BUILD_GENERIC: true
        METAPKG_GIT_CACHE: disabled

    - uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874  # v4.4.0
      with:
        name: builds-linux-aarch64-09
        path: artifacts/linux-aarch64

  test-linux-aarch64-00:
    needs: [build-linux-aarch64-00]
    runs-on: ['package-builder', 'self-hosted', 'linux', 'arm64']

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-linux-aarch64-00
        path: artifacts/linux-aarch64

    - name: Test
      uses: edgedb/edgedb-pkg/integration/linux/test/linux-aarch64@master
      env:
        PKG_SUBDIST: "nightly"
        PKG_PLATFORM: "linux"
        PKG_PLATFORM_VERSION: "aarch64"
        PKG_PLATFORM_LIBC: ""
        # edb test with -j higher than 1 seems to result in workflow
        # jobs getting killed arbitrarily by Github.
        PKG_TEST_JOBS: 0

  test-linux-aarch64-01:
    needs: [build-linux-aarch64-01]
    runs-on: ['package-builder', 'self-hosted', 'linux', 'arm64']

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-linux-aarch64-01
        path: artifacts/linux-aarch64

    - name: Test
      uses: edgedb/edgedb-pkg/integration/linux/test/linux-aarch64@master
      env:
        PKG_SUBDIST: "nightly"
        PKG_PLATFORM: "linux"
        PKG_PLATFORM_VERSION: "aarch64"
        PKG_PLATFORM_LIBC: ""
        # edb test with -j higher than 1 seems to result in workflow
        # jobs getting killed arbitrarily by Github.
        PKG_TEST_JOBS: 0

  test-linux-aarch64-02:
    needs: [build-linux-aarch64-02]
    runs-on: ['package-builder', 'self-hosted', 'linux', 'arm64']

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-linux-aarch64-02
        path: artifacts/linux-aarch64

    - name: Test
      uses: edgedb/edgedb-pkg/integration/linux/test/linux-aarch64@master
      env:
        PKG_SUBDIST: "nightly"
        PKG_PLATFORM: "linux"
        PKG_PLATFORM_VERSION: "aarch64"
        PKG_PLATFORM_LIBC: ""
        # edb test with -j higher than 1 seems to result in workflow
        # jobs getting killed arbitrarily by Github.
        PKG_TEST_JOBS: 0

  test-linux-aarch64-03:
    needs: [build-linux-aarch64-03]
    runs-on: ['package-builder', 'self-hosted', 'linux', 'arm64']

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-linux-aarch64-03
        path: artifacts/linux-aarch64

    - name: Test
      uses: edgedb/edgedb-pkg/integration/linux/test/linux-aarch64@master
      env:
        PKG_SUBDIST: "nightly"
        PKG_PLATFORM: "linux"
        PKG_PLATFORM_VERSION: "aarch64"
        PKG_PLATFORM_LIBC: ""
        # edb test with -j higher than 1 seems to result in workflow
        # jobs getting killed arbitrarily by Github.
        PKG_TEST_JOBS: 0

  test-linux-aarch64-04:
    needs: [build-linux-aarch64-04]
    runs-on: ['package-builder', 'self-hosted', 'linux', 'arm64']

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-linux-aarch64-04
        path: artifacts/linux-aarch64

    - name: Test
      uses: edgedb/edgedb-pkg/integration/linux/test/linux-aarch64@master
      env:
        PKG_SUBDIST: "nightly"
        PKG_PLATFORM: "linux"
        PKG_PLATFORM_VERSION: "aarch64"
        PKG_PLATFORM_LIBC: ""
        # edb test with -j higher than 1 seems to result in workflow
        # jobs getting killed arbitrarily by Github.
        PKG_TEST_JOBS: 0

  test-linux-aarch64-05:
    needs: [build-linux-aarch64-05]
    runs-on: ['package-builder', 'self-hosted', 'linux', 'arm64']

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-linux-aarch64-05
        path: artifacts/linux-aarch64

    - name: Test
      uses: edgedb/edgedb-pkg/integration/linux/test/linux-aarch64@master
      env:
        PKG_SUBDIST: "nightly"
        PKG_PLATFORM: "linux"
        PKG_PLATFORM_VERSION: "aarch64"
        PKG_PLATFORM_LIBC: ""
        # edb test with -j higher than 1 seems to result in workflow
        # jobs getting killed arbitrarily by Github.
        PKG_TEST_JOBS: 0

  test-linux-aarch64-06:
    needs: [build-linux-aarch64-06]
    runs-on: ['package-builder', 'self-hosted', 'linux', 'arm64']

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-linux-aarch64-06
        path: artifacts/linux-aarch64

    - name: Test
      uses: edgedb/edgedb-pkg/integration/linux/test/linux-aarch64@master
      env:
        PKG_SUBDIST: "nightly"
        PKG_PLATFORM: "linux"
        PKG_PLATFORM_VERSION: "aarch64"
        PKG_PLATFORM_LIBC: ""
        # edb test with -j higher than 1 seems to result in workflow
        # jobs getting killed arbitrarily by Github.
        PKG_TEST_JOBS: 0

  test-linux-aarch64-07:
    needs: [build-linux-aarch64-07]
    runs-on: ['package-builder', 'self-hosted', 'linux', 'arm64']

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-linux-aarch64-07
        path: artifacts/linux-aarch64

    - name: Test
      uses: edgedb/edgedb-pkg/integration/linux/test/linux-aarch64@master
      env:
        PKG_SUBDIST: "nightly"
        PKG_PLATFORM: "linux"
        PKG_PLATFORM_VERSION: "aarch64"
        PKG_PLATFORM_LIBC: ""
        # edb test with -j higher than 1 seems to result in workflow
        # jobs getting killed arbitrarily by Github.
        PKG_TEST_JOBS: 0

  test-linux-aarch64-08:
    needs: [build-linux-aarch64-08]
    runs-on: ['package-builder', 'self-hosted', 'linux', 'arm64']

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-linux-aarch64-08
        path: artifacts/linux-aarch64

    - name: Test
      uses: edgedb/edgedb-pkg/integration/linux/test/linux-aarch64@master
      env:
        PKG_SUBDIST: "nightly"
        PKG_PLATFORM: "linux"
        PKG_PLATFORM_VERSION: "aarch64"
        PKG_PLATFORM_LIBC: ""
        # edb test with -j higher than 1 seems to result in workflow
        # jobs getting killed arbitrarily by Github.
        PKG_TEST_JOBS: 0

  test-linux-aarch64-09:
    needs: [build-linux-aarch64-09]
    runs-on: ['package-builder', 'self-hosted', 'linux', 'arm64']

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-linux-aarch64-09
        path: artifacts/linux-aarch64

    - name: Test
      uses: edgedb/edgedb-pkg/integration/linux/test/linux-aarch64@master
      env:
        PKG_SUBDIST: "nightly"
        PKG_PLATFORM: "linux"
        PKG_PLATFORM_VERSION: "aarch64"
        PKG_PLATFORM_LIBC: ""
        # edb test with -j higher than 1 seems to result in workflow
        # jobs getting killed arbitrarily by Github.
        PKG_TEST_JOBS: 0

  workflow-notifications:
    if: failure() && github.event_name != 'pull_request'
    name: Notify in Slack on failures

    needs:
      - prep
      - build-linux-aarch64-00
      - test-linux-aarch64-00
      - build-linux-aarch64-01
      - test-linux-aarch64-01
      - build-linux-aarch64-02
      - test-linux-aarch64-02
      - build-linux-aarch64-03
      - test-linux-aarch64-03
      - build-linux-aarch64-04
      - test-linux-aarch64-04
      - build-linux-aarch64-05
      - test-linux-aarch64-05
      - build-linux-aarch64-06
      - test-linux-aarch64-06
      - build-linux-aarch64-07
      - test-linux-aarch64-07
      - build-linux-aarch64-08
      - test-linux-aarch64-08
      - build-linux-aarch64-09
      - test-linux-aarch64-09
    runs-on: ubuntu-latest
    permissions:
      actions: 'read'
    steps:
      - name: Slack Workflow Notification
        uses: Gamesight/slack-workflow-status@26a36836c887f260477432e4314ec3490a84f309
        with:
          repo_token: ${{secrets.GITHUB_TOKEN}}
          slack_webhook_url: ${{secrets.ACTIONS_SLACK_WEBHOOK_URL}}
          name: 'Workflow notifications'
          icon_emoji: ':hammer:'
          include_jobs: 'on-failure'
