name: Build Test and Publish a Release

on:
  workflow_dispatch:
    inputs: {}

jobs:
  prep:
    runs-on: ubuntu-latest
    outputs:
      branch: ${{ steps.whichver.outputs.branch }}
    steps:
    - uses: actions/checkout@v2

    - name: Determine package version
      shell: bash
      run: |
        branch=${GITHUB_REF#refs/heads/}
        echo ::set-output name=branch::"${branch}"
      id: whichver



  build-debian-stretch-x86_64:
    runs-on: ubuntu-latest
    needs: prep

    steps:
    - name: Build
      uses: edgedb/edgedb-pkg/integration/linux/build/debian-stretch@master
      env:
        SRC_REF: "${{ needs.prep.outputs.branch }}"
        PKG_REVISION: "<current-date>"
        PKG_PLATFORM: "debian"
        PKG_PLATFORM_VERSION: "stretch"
        EXTRA_OPTIMIZATIONS: "true"
        BUILD_IS_RELEASE: "true"



    - uses: actions/upload-artifact@v2
      with:
        name: builds-debian-stretch-x86_64
        path: artifacts/debian-stretch


  build-debian-stretch-aarch64:
    runs-on: ['self-hosted', 'linux', 'arm64']
    needs: prep

    steps:
    - name: Build
      uses: edgedb/edgedb-pkg/integration/linux/build/debian-stretch@master
      env:
        SRC_REF: "${{ needs.prep.outputs.branch }}"
        PKG_REVISION: "<current-date>"
        PKG_PLATFORM: "debian"
        PKG_PLATFORM_VERSION: "stretch"
        EXTRA_OPTIMIZATIONS: "true"
        BUILD_IS_RELEASE: "true"



    - uses: actions/upload-artifact@v2
      with:
        name: builds-debian-stretch-aarch64
        path: artifacts/debian-stretch


  build-debian-buster-x86_64:
    runs-on: ubuntu-latest
    needs: prep

    steps:
    - name: Build
      uses: edgedb/edgedb-pkg/integration/linux/build/debian-buster@master
      env:
        SRC_REF: "${{ needs.prep.outputs.branch }}"
        PKG_REVISION: "<current-date>"
        PKG_PLATFORM: "debian"
        PKG_PLATFORM_VERSION: "buster"
        EXTRA_OPTIMIZATIONS: "true"
        BUILD_IS_RELEASE: "true"



    - uses: actions/upload-artifact@v2
      with:
        name: builds-debian-buster-x86_64
        path: artifacts/debian-buster


  build-debian-buster-aarch64:
    runs-on: ['self-hosted', 'linux', 'arm64']
    needs: prep

    steps:
    - name: Build
      uses: edgedb/edgedb-pkg/integration/linux/build/debian-buster@master
      env:
        SRC_REF: "${{ needs.prep.outputs.branch }}"
        PKG_REVISION: "<current-date>"
        PKG_PLATFORM: "debian"
        PKG_PLATFORM_VERSION: "buster"
        EXTRA_OPTIMIZATIONS: "true"
        BUILD_IS_RELEASE: "true"



    - uses: actions/upload-artifact@v2
      with:
        name: builds-debian-buster-aarch64
        path: artifacts/debian-buster


  build-debian-bullseye-x86_64:
    runs-on: ubuntu-latest
    needs: prep

    steps:
    - name: Build
      uses: edgedb/edgedb-pkg/integration/linux/build/debian-bullseye@master
      env:
        SRC_REF: "${{ needs.prep.outputs.branch }}"
        PKG_REVISION: "<current-date>"
        PKG_PLATFORM: "debian"
        PKG_PLATFORM_VERSION: "bullseye"
        EXTRA_OPTIMIZATIONS: "true"
        BUILD_IS_RELEASE: "true"



    - uses: actions/upload-artifact@v2
      with:
        name: builds-debian-bullseye-x86_64
        path: artifacts/debian-bullseye


  build-debian-bullseye-aarch64:
    runs-on: ['self-hosted', 'linux', 'arm64']
    needs: prep

    steps:
    - name: Build
      uses: edgedb/edgedb-pkg/integration/linux/build/debian-bullseye@master
      env:
        SRC_REF: "${{ needs.prep.outputs.branch }}"
        PKG_REVISION: "<current-date>"
        PKG_PLATFORM: "debian"
        PKG_PLATFORM_VERSION: "bullseye"
        EXTRA_OPTIMIZATIONS: "true"
        BUILD_IS_RELEASE: "true"



    - uses: actions/upload-artifact@v2
      with:
        name: builds-debian-bullseye-aarch64
        path: artifacts/debian-bullseye


  build-ubuntu-xenial-x86_64:
    runs-on: ubuntu-latest
    needs: prep

    steps:
    - name: Build
      uses: edgedb/edgedb-pkg/integration/linux/build/ubuntu-xenial@master
      env:
        SRC_REF: "${{ needs.prep.outputs.branch }}"
        PKG_REVISION: "<current-date>"
        PKG_PLATFORM: "ubuntu"
        PKG_PLATFORM_VERSION: "xenial"
        EXTRA_OPTIMIZATIONS: "true"
        BUILD_IS_RELEASE: "true"



    - uses: actions/upload-artifact@v2
      with:
        name: builds-ubuntu-xenial-x86_64
        path: artifacts/ubuntu-xenial


  build-ubuntu-xenial-aarch64:
    runs-on: ['self-hosted', 'linux', 'arm64']
    needs: prep

    steps:
    - name: Build
      uses: edgedb/edgedb-pkg/integration/linux/build/ubuntu-xenial@master
      env:
        SRC_REF: "${{ needs.prep.outputs.branch }}"
        PKG_REVISION: "<current-date>"
        PKG_PLATFORM: "ubuntu"
        PKG_PLATFORM_VERSION: "xenial"
        EXTRA_OPTIMIZATIONS: "true"
        BUILD_IS_RELEASE: "true"



    - uses: actions/upload-artifact@v2
      with:
        name: builds-ubuntu-xenial-aarch64
        path: artifacts/ubuntu-xenial


  build-ubuntu-bionic-x86_64:
    runs-on: ubuntu-latest
    needs: prep

    steps:
    - name: Build
      uses: edgedb/edgedb-pkg/integration/linux/build/ubuntu-bionic@master
      env:
        SRC_REF: "${{ needs.prep.outputs.branch }}"
        PKG_REVISION: "<current-date>"
        PKG_PLATFORM: "ubuntu"
        PKG_PLATFORM_VERSION: "bionic"
        EXTRA_OPTIMIZATIONS: "true"
        BUILD_IS_RELEASE: "true"



    - uses: actions/upload-artifact@v2
      with:
        name: builds-ubuntu-bionic-x86_64
        path: artifacts/ubuntu-bionic


  build-ubuntu-bionic-aarch64:
    runs-on: ['self-hosted', 'linux', 'arm64']
    needs: prep

    steps:
    - name: Build
      uses: edgedb/edgedb-pkg/integration/linux/build/ubuntu-bionic@master
      env:
        SRC_REF: "${{ needs.prep.outputs.branch }}"
        PKG_REVISION: "<current-date>"
        PKG_PLATFORM: "ubuntu"
        PKG_PLATFORM_VERSION: "bionic"
        EXTRA_OPTIMIZATIONS: "true"
        BUILD_IS_RELEASE: "true"



    - uses: actions/upload-artifact@v2
      with:
        name: builds-ubuntu-bionic-aarch64
        path: artifacts/ubuntu-bionic


  build-ubuntu-focal-x86_64:
    runs-on: ubuntu-latest
    needs: prep

    steps:
    - name: Build
      uses: edgedb/edgedb-pkg/integration/linux/build/ubuntu-focal@master
      env:
        SRC_REF: "${{ needs.prep.outputs.branch }}"
        PKG_REVISION: "<current-date>"
        PKG_PLATFORM: "ubuntu"
        PKG_PLATFORM_VERSION: "focal"
        EXTRA_OPTIMIZATIONS: "true"
        BUILD_IS_RELEASE: "true"



    - uses: actions/upload-artifact@v2
      with:
        name: builds-ubuntu-focal-x86_64
        path: artifacts/ubuntu-focal


  build-ubuntu-focal-aarch64:
    runs-on: ['self-hosted', 'linux', 'arm64']
    needs: prep

    steps:
    - name: Build
      uses: edgedb/edgedb-pkg/integration/linux/build/ubuntu-focal@master
      env:
        SRC_REF: "${{ needs.prep.outputs.branch }}"
        PKG_REVISION: "<current-date>"
        PKG_PLATFORM: "ubuntu"
        PKG_PLATFORM_VERSION: "focal"
        EXTRA_OPTIMIZATIONS: "true"
        BUILD_IS_RELEASE: "true"



    - uses: actions/upload-artifact@v2
      with:
        name: builds-ubuntu-focal-aarch64
        path: artifacts/ubuntu-focal


  build-ubuntu-jammy-x86_64:
    runs-on: ubuntu-latest
    needs: prep

    steps:
    - name: Build
      uses: edgedb/edgedb-pkg/integration/linux/build/ubuntu-jammy@master
      env:
        SRC_REF: "${{ needs.prep.outputs.branch }}"
        PKG_REVISION: "<current-date>"
        PKG_PLATFORM: "ubuntu"
        PKG_PLATFORM_VERSION: "jammy"
        EXTRA_OPTIMIZATIONS: "true"
        BUILD_IS_RELEASE: "true"



    - uses: actions/upload-artifact@v2
      with:
        name: builds-ubuntu-jammy-x86_64
        path: artifacts/ubuntu-jammy


  build-ubuntu-jammy-aarch64:
    runs-on: ['self-hosted', 'linux', 'arm64']
    needs: prep

    steps:
    - name: Build
      uses: edgedb/edgedb-pkg/integration/linux/build/ubuntu-jammy@master
      env:
        SRC_REF: "${{ needs.prep.outputs.branch }}"
        PKG_REVISION: "<current-date>"
        PKG_PLATFORM: "ubuntu"
        PKG_PLATFORM_VERSION: "jammy"
        EXTRA_OPTIMIZATIONS: "true"
        BUILD_IS_RELEASE: "true"



    - uses: actions/upload-artifact@v2
      with:
        name: builds-ubuntu-jammy-aarch64
        path: artifacts/ubuntu-jammy


  build-centos-7-x86_64:
    runs-on: ubuntu-latest
    needs: prep

    steps:
    - name: Build
      uses: edgedb/edgedb-pkg/integration/linux/build/centos-7@master
      env:
        SRC_REF: "${{ needs.prep.outputs.branch }}"
        PKG_REVISION: "<current-date>"
        PKG_PLATFORM: "centos"
        PKG_PLATFORM_VERSION: "7"
        EXTRA_OPTIMIZATIONS: "true"
        BUILD_IS_RELEASE: "true"



    - uses: actions/upload-artifact@v2
      with:
        name: builds-centos-7-x86_64
        path: artifacts/centos-7


  build-centos-8-x86_64:
    runs-on: ubuntu-latest
    needs: prep

    steps:
    - name: Build
      uses: edgedb/edgedb-pkg/integration/linux/build/centos-8@master
      env:
        SRC_REF: "${{ needs.prep.outputs.branch }}"
        PKG_REVISION: "<current-date>"
        PKG_PLATFORM: "centos"
        PKG_PLATFORM_VERSION: "8"
        EXTRA_OPTIMIZATIONS: "true"
        BUILD_IS_RELEASE: "true"



    - uses: actions/upload-artifact@v2
      with:
        name: builds-centos-8-x86_64
        path: artifacts/centos-8


  build-centos-8-aarch64:
    runs-on: ['self-hosted', 'linux', 'arm64']
    needs: prep

    steps:
    - name: Build
      uses: edgedb/edgedb-pkg/integration/linux/build/centos-8@master
      env:
        SRC_REF: "${{ needs.prep.outputs.branch }}"
        PKG_REVISION: "<current-date>"
        PKG_PLATFORM: "centos"
        PKG_PLATFORM_VERSION: "8"
        EXTRA_OPTIMIZATIONS: "true"
        BUILD_IS_RELEASE: "true"



    - uses: actions/upload-artifact@v2
      with:
        name: builds-centos-8-aarch64
        path: artifacts/centos-8


  build-linux-x86_64:
    runs-on: ubuntu-latest
    needs: prep

    steps:
    - name: Build
      uses: edgedb/edgedb-pkg/integration/linux/build/linux-x86_64@master
      env:
        SRC_REF: "${{ needs.prep.outputs.branch }}"
        PKG_REVISION: "<current-date>"
        PKG_PLATFORM: "linux"
        PKG_PLATFORM_VERSION: "x86_64"
        EXTRA_OPTIMIZATIONS: "true"
        BUILD_IS_RELEASE: "true"

        BUILD_GENERIC: true



    - uses: actions/upload-artifact@v2
      with:
        name: builds-linux-x86_64
        path: artifacts/linux-x86_64


  build-linux-aarch64:
    runs-on: ['self-hosted', 'linux', 'arm64']
    needs: prep

    steps:
    - name: Build
      uses: edgedb/edgedb-pkg/integration/linux/build/linux-aarch64@master
      env:
        SRC_REF: "${{ needs.prep.outputs.branch }}"
        PKG_REVISION: "<current-date>"
        PKG_PLATFORM: "linux"
        PKG_PLATFORM_VERSION: "aarch64"
        EXTRA_OPTIMIZATIONS: "true"
        BUILD_IS_RELEASE: "true"

        BUILD_GENERIC: true



    - uses: actions/upload-artifact@v2
      with:
        name: builds-linux-aarch64
        path: artifacts/linux-aarch64



  build-macos-x86_64:
    runs-on: macos-latest
    needs: prep

    steps:
    - uses: actions/checkout@v2
      with:
        repository: edgedb/edgedb-pkg
        ref: master
        path: edgedb-pkg

    - name: Install Rust toolchain
      uses: actions-rs/toolchain@v1
      if: true
      with:
        profile: minimal
        toolchain: stable
        default: true

    - name: Set up Python
      uses: actions/setup-python@v1
      if: true

    - name: Build
      env:
        SRC_REF: "${{ needs.prep.outputs.branch }}"
        BUILD_IS_RELEASE: "true"
        PKG_REVISION: "<current-date>"
        PKG_PLATFORM: "macos"
        PKG_PLATFORM_VERSION: "x86_64"

        BUILD_GENERIC: true

      run: |
        edgedb-pkg/integration/macos/build.sh

    - uses: actions/upload-artifact@v1
      with:
        name: builds-macos-x86_64
        path: artifacts/macos-x86_64


  build-macos-aarch64:
    runs-on: ['self-hosted', 'macOS', 'ARM64']
    needs: prep

    steps:
    - uses: actions/checkout@v2
      with:
        repository: edgedb/edgedb-pkg
        ref: master
        path: edgedb-pkg

    - name: Install Rust toolchain
      uses: actions-rs/toolchain@v1
      if: false
      with:
        profile: minimal
        toolchain: stable
        default: true

    - name: Set up Python
      uses: actions/setup-python@v1
      if: false

    - name: Build
      env:
        SRC_REF: "${{ needs.prep.outputs.branch }}"
        BUILD_IS_RELEASE: "true"
        PKG_REVISION: "<current-date>"
        PKG_PLATFORM: "macos"
        PKG_PLATFORM_VERSION: "aarch64"

        BUILD_GENERIC: true

      run: |
        edgedb-pkg/integration/macos/build.sh

    - uses: actions/upload-artifact@v1
      with:
        name: builds-macos-aarch64
        path: artifacts/macos-aarch64



  test-debian-stretch-x86_64:
    needs: [build-debian-stretch-x86_64]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/download-artifact@v2
      with:
        name: builds-debian-stretch-x86_64
        path: artifacts/debian-stretch

    - name: Test
      uses: edgedb/edgedb-pkg/integration/linux/test/debian-stretch@master
      env:
        PKG_PLATFORM: "debian"
        PKG_PLATFORM_VERSION: "stretch"
        # edb test with -j higher than 1 seems to result in workflow
        # jobs getting killed arbitrarily by Github.
        PKG_TEST_JOBS: 1



  test-debian-stretch-aarch64:
    needs: [build-debian-stretch-aarch64]
    runs-on: ['self-hosted', 'linux', 'arm64']

    steps:
    - uses: actions/download-artifact@v2
      with:
        name: builds-debian-stretch-aarch64
        path: artifacts/debian-stretch

    - name: Test
      uses: edgedb/edgedb-pkg/integration/linux/test/debian-stretch@master
      env:
        PKG_PLATFORM: "debian"
        PKG_PLATFORM_VERSION: "stretch"
        # edb test with -j higher than 1 seems to result in workflow
        # jobs getting killed arbitrarily by Github.
        PKG_TEST_JOBS: 0



  test-debian-buster-x86_64:
    needs: [build-debian-buster-x86_64]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/download-artifact@v2
      with:
        name: builds-debian-buster-x86_64
        path: artifacts/debian-buster

    - name: Test
      uses: edgedb/edgedb-pkg/integration/linux/test/debian-buster@master
      env:
        PKG_PLATFORM: "debian"
        PKG_PLATFORM_VERSION: "buster"
        # edb test with -j higher than 1 seems to result in workflow
        # jobs getting killed arbitrarily by Github.
        PKG_TEST_JOBS: 1



  test-debian-buster-aarch64:
    needs: [build-debian-buster-aarch64]
    runs-on: ['self-hosted', 'linux', 'arm64']

    steps:
    - uses: actions/download-artifact@v2
      with:
        name: builds-debian-buster-aarch64
        path: artifacts/debian-buster

    - name: Test
      uses: edgedb/edgedb-pkg/integration/linux/test/debian-buster@master
      env:
        PKG_PLATFORM: "debian"
        PKG_PLATFORM_VERSION: "buster"
        # edb test with -j higher than 1 seems to result in workflow
        # jobs getting killed arbitrarily by Github.
        PKG_TEST_JOBS: 0



  test-debian-bullseye-x86_64:
    needs: [build-debian-bullseye-x86_64]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/download-artifact@v2
      with:
        name: builds-debian-bullseye-x86_64
        path: artifacts/debian-bullseye

    - name: Test
      uses: edgedb/edgedb-pkg/integration/linux/test/debian-bullseye@master
      env:
        PKG_PLATFORM: "debian"
        PKG_PLATFORM_VERSION: "bullseye"
        # edb test with -j higher than 1 seems to result in workflow
        # jobs getting killed arbitrarily by Github.
        PKG_TEST_JOBS: 1



  test-debian-bullseye-aarch64:
    needs: [build-debian-bullseye-aarch64]
    runs-on: ['self-hosted', 'linux', 'arm64']

    steps:
    - uses: actions/download-artifact@v2
      with:
        name: builds-debian-bullseye-aarch64
        path: artifacts/debian-bullseye

    - name: Test
      uses: edgedb/edgedb-pkg/integration/linux/test/debian-bullseye@master
      env:
        PKG_PLATFORM: "debian"
        PKG_PLATFORM_VERSION: "bullseye"
        # edb test with -j higher than 1 seems to result in workflow
        # jobs getting killed arbitrarily by Github.
        PKG_TEST_JOBS: 0



  test-ubuntu-xenial-x86_64:
    needs: [build-ubuntu-xenial-x86_64]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/download-artifact@v2
      with:
        name: builds-ubuntu-xenial-x86_64
        path: artifacts/ubuntu-xenial

    - name: Test
      uses: edgedb/edgedb-pkg/integration/linux/test/ubuntu-xenial@master
      env:
        PKG_PLATFORM: "ubuntu"
        PKG_PLATFORM_VERSION: "xenial"
        # edb test with -j higher than 1 seems to result in workflow
        # jobs getting killed arbitrarily by Github.
        PKG_TEST_JOBS: 1



  test-ubuntu-xenial-aarch64:
    needs: [build-ubuntu-xenial-aarch64]
    runs-on: ['self-hosted', 'linux', 'arm64']

    steps:
    - uses: actions/download-artifact@v2
      with:
        name: builds-ubuntu-xenial-aarch64
        path: artifacts/ubuntu-xenial

    - name: Test
      uses: edgedb/edgedb-pkg/integration/linux/test/ubuntu-xenial@master
      env:
        PKG_PLATFORM: "ubuntu"
        PKG_PLATFORM_VERSION: "xenial"
        # edb test with -j higher than 1 seems to result in workflow
        # jobs getting killed arbitrarily by Github.
        PKG_TEST_JOBS: 0



  test-ubuntu-bionic-x86_64:
    needs: [build-ubuntu-bionic-x86_64]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/download-artifact@v2
      with:
        name: builds-ubuntu-bionic-x86_64
        path: artifacts/ubuntu-bionic

    - name: Test
      uses: edgedb/edgedb-pkg/integration/linux/test/ubuntu-bionic@master
      env:
        PKG_PLATFORM: "ubuntu"
        PKG_PLATFORM_VERSION: "bionic"
        # edb test with -j higher than 1 seems to result in workflow
        # jobs getting killed arbitrarily by Github.
        PKG_TEST_JOBS: 1



  test-ubuntu-bionic-aarch64:
    needs: [build-ubuntu-bionic-aarch64]
    runs-on: ['self-hosted', 'linux', 'arm64']

    steps:
    - uses: actions/download-artifact@v2
      with:
        name: builds-ubuntu-bionic-aarch64
        path: artifacts/ubuntu-bionic

    - name: Test
      uses: edgedb/edgedb-pkg/integration/linux/test/ubuntu-bionic@master
      env:
        PKG_PLATFORM: "ubuntu"
        PKG_PLATFORM_VERSION: "bionic"
        # edb test with -j higher than 1 seems to result in workflow
        # jobs getting killed arbitrarily by Github.
        PKG_TEST_JOBS: 0



  test-ubuntu-focal-x86_64:
    needs: [build-ubuntu-focal-x86_64]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/download-artifact@v2
      with:
        name: builds-ubuntu-focal-x86_64
        path: artifacts/ubuntu-focal

    - name: Test
      uses: edgedb/edgedb-pkg/integration/linux/test/ubuntu-focal@master
      env:
        PKG_PLATFORM: "ubuntu"
        PKG_PLATFORM_VERSION: "focal"
        # edb test with -j higher than 1 seems to result in workflow
        # jobs getting killed arbitrarily by Github.
        PKG_TEST_JOBS: 1



  test-ubuntu-focal-aarch64:
    needs: [build-ubuntu-focal-aarch64]
    runs-on: ['self-hosted', 'linux', 'arm64']

    steps:
    - uses: actions/download-artifact@v2
      with:
        name: builds-ubuntu-focal-aarch64
        path: artifacts/ubuntu-focal

    - name: Test
      uses: edgedb/edgedb-pkg/integration/linux/test/ubuntu-focal@master
      env:
        PKG_PLATFORM: "ubuntu"
        PKG_PLATFORM_VERSION: "focal"
        # edb test with -j higher than 1 seems to result in workflow
        # jobs getting killed arbitrarily by Github.
        PKG_TEST_JOBS: 0



  test-ubuntu-jammy-x86_64:
    needs: [build-ubuntu-jammy-x86_64]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/download-artifact@v2
      with:
        name: builds-ubuntu-jammy-x86_64
        path: artifacts/ubuntu-jammy

    - name: Test
      uses: edgedb/edgedb-pkg/integration/linux/test/ubuntu-jammy@master
      env:
        PKG_PLATFORM: "ubuntu"
        PKG_PLATFORM_VERSION: "jammy"
        # edb test with -j higher than 1 seems to result in workflow
        # jobs getting killed arbitrarily by Github.
        PKG_TEST_JOBS: 1



  test-ubuntu-jammy-aarch64:
    needs: [build-ubuntu-jammy-aarch64]
    runs-on: ['self-hosted', 'linux', 'arm64']

    steps:
    - uses: actions/download-artifact@v2
      with:
        name: builds-ubuntu-jammy-aarch64
        path: artifacts/ubuntu-jammy

    - name: Test
      uses: edgedb/edgedb-pkg/integration/linux/test/ubuntu-jammy@master
      env:
        PKG_PLATFORM: "ubuntu"
        PKG_PLATFORM_VERSION: "jammy"
        # edb test with -j higher than 1 seems to result in workflow
        # jobs getting killed arbitrarily by Github.
        PKG_TEST_JOBS: 0



  test-centos-7-x86_64:
    needs: [build-centos-7-x86_64]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/download-artifact@v2
      with:
        name: builds-centos-7-x86_64
        path: artifacts/centos-7

    - name: Test
      uses: edgedb/edgedb-pkg/integration/linux/test/centos-7@master
      env:
        PKG_PLATFORM: "centos"
        PKG_PLATFORM_VERSION: "7"
        # edb test with -j higher than 1 seems to result in workflow
        # jobs getting killed arbitrarily by Github.
        PKG_TEST_JOBS: 1



  test-centos-8-x86_64:
    needs: [build-centos-8-x86_64]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/download-artifact@v2
      with:
        name: builds-centos-8-x86_64
        path: artifacts/centos-8

    - name: Test
      uses: edgedb/edgedb-pkg/integration/linux/test/centos-8@master
      env:
        PKG_PLATFORM: "centos"
        PKG_PLATFORM_VERSION: "8"
        # edb test with -j higher than 1 seems to result in workflow
        # jobs getting killed arbitrarily by Github.
        PKG_TEST_JOBS: 1



  test-centos-8-aarch64:
    needs: [build-centos-8-aarch64]
    runs-on: ['self-hosted', 'linux', 'arm64']

    steps:
    - uses: actions/download-artifact@v2
      with:
        name: builds-centos-8-aarch64
        path: artifacts/centos-8

    - name: Test
      uses: edgedb/edgedb-pkg/integration/linux/test/centos-8@master
      env:
        PKG_PLATFORM: "centos"
        PKG_PLATFORM_VERSION: "8"
        # edb test with -j higher than 1 seems to result in workflow
        # jobs getting killed arbitrarily by Github.
        PKG_TEST_JOBS: 0



  test-linux-x86_64:
    needs: [build-linux-x86_64]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/download-artifact@v2
      with:
        name: builds-linux-x86_64
        path: artifacts/linux-x86_64

    - name: Test
      uses: edgedb/edgedb-pkg/integration/linux/test/linux-x86_64@master
      env:
        PKG_PLATFORM: "linux"
        PKG_PLATFORM_VERSION: "x86_64"
        # edb test with -j higher than 1 seems to result in workflow
        # jobs getting killed arbitrarily by Github.
        PKG_TEST_JOBS: 1



  test-linux-aarch64:
    needs: [build-linux-aarch64]
    runs-on: ['self-hosted', 'linux', 'arm64']

    steps:
    - uses: actions/download-artifact@v2
      with:
        name: builds-linux-aarch64
        path: artifacts/linux-aarch64

    - name: Test
      uses: edgedb/edgedb-pkg/integration/linux/test/linux-aarch64@master
      env:
        PKG_PLATFORM: "linux"
        PKG_PLATFORM_VERSION: "aarch64"
        # edb test with -j higher than 1 seems to result in workflow
        # jobs getting killed arbitrarily by Github.
        PKG_TEST_JOBS: 0




  test-macos-x86_64:
    needs: [build-macos-x86_64]
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v2
      with:
        repository: edgedb/edgedb-pkg
        ref: master
        path: edgedb-pkg

    - uses: actions/download-artifact@v2
      with:
        name: builds-macos-x86_64
        path: artifacts/macos-x86_64

    - name: Test
      env:
        PKG_PLATFORM: "macos"
        PKG_PLATFORM_VERSION: "x86_64"
      run: |
        edgedb-pkg/integration/macos/test.sh


  test-macos-aarch64:
    needs: [build-macos-aarch64]
    runs-on: ['self-hosted', 'macOS', 'ARM64']

    steps:
    - uses: actions/checkout@v2
      with:
        repository: edgedb/edgedb-pkg
        ref: master
        path: edgedb-pkg

    - uses: actions/download-artifact@v2
      with:
        name: builds-macos-aarch64
        path: artifacts/macos-aarch64

    - name: Test
      env:
        PKG_PLATFORM: "macos"
        PKG_PLATFORM_VERSION: "aarch64"
      run: |
        edgedb-pkg/integration/macos/test.sh



  publish-debian-stretch-x86_64:
    needs: [test-debian-stretch-x86_64]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/download-artifact@v2
      with:
        name: builds-debian-stretch-x86_64
        path: artifacts/debian-stretch

    - name: Publish
      uses: edgedb/edgedb-pkg/integration/linux/upload/linux-x86_64@master
      env:
        PKG_PLATFORM: "debian"
        PKG_PLATFORM_VERSION: "stretch"
        PACKAGE_UPLOAD_SSH_KEY: "${{ secrets.PACKAGE_UPLOAD_SSH_KEY }}"

  check-published-debian-stretch-x86_64:
    needs: [publish-debian-stretch-x86_64]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/download-artifact@v2
      with:
        name: builds-debian-stretch-x86_64
        path: artifacts/debian-stretch

    - name: Describe
      id: describe
      uses: edgedb/edgedb-pkg/integration/actions/describe-artifact@master
      with:
        target: debian-stretch

    - name: Test Published
      uses: edgedb/edgedb-pkg/integration/linux/testpublished/debian-stretch@master
      env:
        PKG_PLATFORM: "debian"
        PKG_PLATFORM_VERSION: "stretch"
        PKG_INSTALL_REF: "${{ steps.describe.outputs.install-ref }}"
        PKG_VERSION_SLOT: "${{ steps.describe.outputs.version-slot }}"

    


  publish-debian-stretch-aarch64:
    needs: [test-debian-stretch-aarch64]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/download-artifact@v2
      with:
        name: builds-debian-stretch-aarch64
        path: artifacts/debian-stretch

    - name: Publish
      uses: edgedb/edgedb-pkg/integration/linux/upload/linux-x86_64@master
      env:
        PKG_PLATFORM: "debian"
        PKG_PLATFORM_VERSION: "stretch"
        PACKAGE_UPLOAD_SSH_KEY: "${{ secrets.PACKAGE_UPLOAD_SSH_KEY }}"

  check-published-debian-stretch-aarch64:
    needs: [publish-debian-stretch-aarch64]
    runs-on: ['self-hosted', 'linux', 'arm64']

    steps:
    - uses: actions/download-artifact@v2
      with:
        name: builds-debian-stretch-aarch64
        path: artifacts/debian-stretch

    - name: Describe
      id: describe
      uses: edgedb/edgedb-pkg/integration/actions/describe-artifact@master
      with:
        target: debian-stretch

    - name: Test Published
      uses: edgedb/edgedb-pkg/integration/linux/testpublished/debian-stretch@master
      env:
        PKG_PLATFORM: "debian"
        PKG_PLATFORM_VERSION: "stretch"
        PKG_INSTALL_REF: "${{ steps.describe.outputs.install-ref }}"
        PKG_VERSION_SLOT: "${{ steps.describe.outputs.version-slot }}"

    


  publish-debian-buster-x86_64:
    needs: [test-debian-buster-x86_64]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/download-artifact@v2
      with:
        name: builds-debian-buster-x86_64
        path: artifacts/debian-buster

    - name: Publish
      uses: edgedb/edgedb-pkg/integration/linux/upload/linux-x86_64@master
      env:
        PKG_PLATFORM: "debian"
        PKG_PLATFORM_VERSION: "buster"
        PACKAGE_UPLOAD_SSH_KEY: "${{ secrets.PACKAGE_UPLOAD_SSH_KEY }}"

  check-published-debian-buster-x86_64:
    needs: [publish-debian-buster-x86_64]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/download-artifact@v2
      with:
        name: builds-debian-buster-x86_64
        path: artifacts/debian-buster

    - name: Describe
      id: describe
      uses: edgedb/edgedb-pkg/integration/actions/describe-artifact@master
      with:
        target: debian-buster

    - name: Test Published
      uses: edgedb/edgedb-pkg/integration/linux/testpublished/debian-buster@master
      env:
        PKG_PLATFORM: "debian"
        PKG_PLATFORM_VERSION: "buster"
        PKG_INSTALL_REF: "${{ steps.describe.outputs.install-ref }}"
        PKG_VERSION_SLOT: "${{ steps.describe.outputs.version-slot }}"

    


  publish-debian-buster-aarch64:
    needs: [test-debian-buster-aarch64]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/download-artifact@v2
      with:
        name: builds-debian-buster-aarch64
        path: artifacts/debian-buster

    - name: Publish
      uses: edgedb/edgedb-pkg/integration/linux/upload/linux-x86_64@master
      env:
        PKG_PLATFORM: "debian"
        PKG_PLATFORM_VERSION: "buster"
        PACKAGE_UPLOAD_SSH_KEY: "${{ secrets.PACKAGE_UPLOAD_SSH_KEY }}"

  check-published-debian-buster-aarch64:
    needs: [publish-debian-buster-aarch64]
    runs-on: ['self-hosted', 'linux', 'arm64']

    steps:
    - uses: actions/download-artifact@v2
      with:
        name: builds-debian-buster-aarch64
        path: artifacts/debian-buster

    - name: Describe
      id: describe
      uses: edgedb/edgedb-pkg/integration/actions/describe-artifact@master
      with:
        target: debian-buster

    - name: Test Published
      uses: edgedb/edgedb-pkg/integration/linux/testpublished/debian-buster@master
      env:
        PKG_PLATFORM: "debian"
        PKG_PLATFORM_VERSION: "buster"
        PKG_INSTALL_REF: "${{ steps.describe.outputs.install-ref }}"
        PKG_VERSION_SLOT: "${{ steps.describe.outputs.version-slot }}"

    


  publish-debian-bullseye-x86_64:
    needs: [test-debian-bullseye-x86_64]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/download-artifact@v2
      with:
        name: builds-debian-bullseye-x86_64
        path: artifacts/debian-bullseye

    - name: Publish
      uses: edgedb/edgedb-pkg/integration/linux/upload/linux-x86_64@master
      env:
        PKG_PLATFORM: "debian"
        PKG_PLATFORM_VERSION: "bullseye"
        PACKAGE_UPLOAD_SSH_KEY: "${{ secrets.PACKAGE_UPLOAD_SSH_KEY }}"

  check-published-debian-bullseye-x86_64:
    needs: [publish-debian-bullseye-x86_64]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/download-artifact@v2
      with:
        name: builds-debian-bullseye-x86_64
        path: artifacts/debian-bullseye

    - name: Describe
      id: describe
      uses: edgedb/edgedb-pkg/integration/actions/describe-artifact@master
      with:
        target: debian-bullseye

    - name: Test Published
      uses: edgedb/edgedb-pkg/integration/linux/testpublished/debian-bullseye@master
      env:
        PKG_PLATFORM: "debian"
        PKG_PLATFORM_VERSION: "bullseye"
        PKG_INSTALL_REF: "${{ steps.describe.outputs.install-ref }}"
        PKG_VERSION_SLOT: "${{ steps.describe.outputs.version-slot }}"

    


  publish-debian-bullseye-aarch64:
    needs: [test-debian-bullseye-aarch64]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/download-artifact@v2
      with:
        name: builds-debian-bullseye-aarch64
        path: artifacts/debian-bullseye

    - name: Publish
      uses: edgedb/edgedb-pkg/integration/linux/upload/linux-x86_64@master
      env:
        PKG_PLATFORM: "debian"
        PKG_PLATFORM_VERSION: "bullseye"
        PACKAGE_UPLOAD_SSH_KEY: "${{ secrets.PACKAGE_UPLOAD_SSH_KEY }}"

  check-published-debian-bullseye-aarch64:
    needs: [publish-debian-bullseye-aarch64]
    runs-on: ['self-hosted', 'linux', 'arm64']

    steps:
    - uses: actions/download-artifact@v2
      with:
        name: builds-debian-bullseye-aarch64
        path: artifacts/debian-bullseye

    - name: Describe
      id: describe
      uses: edgedb/edgedb-pkg/integration/actions/describe-artifact@master
      with:
        target: debian-bullseye

    - name: Test Published
      uses: edgedb/edgedb-pkg/integration/linux/testpublished/debian-bullseye@master
      env:
        PKG_PLATFORM: "debian"
        PKG_PLATFORM_VERSION: "bullseye"
        PKG_INSTALL_REF: "${{ steps.describe.outputs.install-ref }}"
        PKG_VERSION_SLOT: "${{ steps.describe.outputs.version-slot }}"

    


  publish-ubuntu-xenial-x86_64:
    needs: [test-ubuntu-xenial-x86_64]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/download-artifact@v2
      with:
        name: builds-ubuntu-xenial-x86_64
        path: artifacts/ubuntu-xenial

    - name: Publish
      uses: edgedb/edgedb-pkg/integration/linux/upload/linux-x86_64@master
      env:
        PKG_PLATFORM: "ubuntu"
        PKG_PLATFORM_VERSION: "xenial"
        PACKAGE_UPLOAD_SSH_KEY: "${{ secrets.PACKAGE_UPLOAD_SSH_KEY }}"

  check-published-ubuntu-xenial-x86_64:
    needs: [publish-ubuntu-xenial-x86_64]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/download-artifact@v2
      with:
        name: builds-ubuntu-xenial-x86_64
        path: artifacts/ubuntu-xenial

    - name: Describe
      id: describe
      uses: edgedb/edgedb-pkg/integration/actions/describe-artifact@master
      with:
        target: ubuntu-xenial

    - name: Test Published
      uses: edgedb/edgedb-pkg/integration/linux/testpublished/ubuntu-xenial@master
      env:
        PKG_PLATFORM: "ubuntu"
        PKG_PLATFORM_VERSION: "xenial"
        PKG_INSTALL_REF: "${{ steps.describe.outputs.install-ref }}"
        PKG_VERSION_SLOT: "${{ steps.describe.outputs.version-slot }}"

    


  publish-ubuntu-xenial-aarch64:
    needs: [test-ubuntu-xenial-aarch64]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/download-artifact@v2
      with:
        name: builds-ubuntu-xenial-aarch64
        path: artifacts/ubuntu-xenial

    - name: Publish
      uses: edgedb/edgedb-pkg/integration/linux/upload/linux-x86_64@master
      env:
        PKG_PLATFORM: "ubuntu"
        PKG_PLATFORM_VERSION: "xenial"
        PACKAGE_UPLOAD_SSH_KEY: "${{ secrets.PACKAGE_UPLOAD_SSH_KEY }}"

  check-published-ubuntu-xenial-aarch64:
    needs: [publish-ubuntu-xenial-aarch64]
    runs-on: ['self-hosted', 'linux', 'arm64']

    steps:
    - uses: actions/download-artifact@v2
      with:
        name: builds-ubuntu-xenial-aarch64
        path: artifacts/ubuntu-xenial

    - name: Describe
      id: describe
      uses: edgedb/edgedb-pkg/integration/actions/describe-artifact@master
      with:
        target: ubuntu-xenial

    - name: Test Published
      uses: edgedb/edgedb-pkg/integration/linux/testpublished/ubuntu-xenial@master
      env:
        PKG_PLATFORM: "ubuntu"
        PKG_PLATFORM_VERSION: "xenial"
        PKG_INSTALL_REF: "${{ steps.describe.outputs.install-ref }}"
        PKG_VERSION_SLOT: "${{ steps.describe.outputs.version-slot }}"

    


  publish-ubuntu-bionic-x86_64:
    needs: [test-ubuntu-bionic-x86_64]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/download-artifact@v2
      with:
        name: builds-ubuntu-bionic-x86_64
        path: artifacts/ubuntu-bionic

    - name: Publish
      uses: edgedb/edgedb-pkg/integration/linux/upload/linux-x86_64@master
      env:
        PKG_PLATFORM: "ubuntu"
        PKG_PLATFORM_VERSION: "bionic"
        PACKAGE_UPLOAD_SSH_KEY: "${{ secrets.PACKAGE_UPLOAD_SSH_KEY }}"

  check-published-ubuntu-bionic-x86_64:
    needs: [publish-ubuntu-bionic-x86_64]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/download-artifact@v2
      with:
        name: builds-ubuntu-bionic-x86_64
        path: artifacts/ubuntu-bionic

    - name: Describe
      id: describe
      uses: edgedb/edgedb-pkg/integration/actions/describe-artifact@master
      with:
        target: ubuntu-bionic

    - name: Test Published
      uses: edgedb/edgedb-pkg/integration/linux/testpublished/ubuntu-bionic@master
      env:
        PKG_PLATFORM: "ubuntu"
        PKG_PLATFORM_VERSION: "bionic"
        PKG_INSTALL_REF: "${{ steps.describe.outputs.install-ref }}"
        PKG_VERSION_SLOT: "${{ steps.describe.outputs.version-slot }}"

    


  publish-ubuntu-bionic-aarch64:
    needs: [test-ubuntu-bionic-aarch64]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/download-artifact@v2
      with:
        name: builds-ubuntu-bionic-aarch64
        path: artifacts/ubuntu-bionic

    - name: Publish
      uses: edgedb/edgedb-pkg/integration/linux/upload/linux-x86_64@master
      env:
        PKG_PLATFORM: "ubuntu"
        PKG_PLATFORM_VERSION: "bionic"
        PACKAGE_UPLOAD_SSH_KEY: "${{ secrets.PACKAGE_UPLOAD_SSH_KEY }}"

  check-published-ubuntu-bionic-aarch64:
    needs: [publish-ubuntu-bionic-aarch64]
    runs-on: ['self-hosted', 'linux', 'arm64']

    steps:
    - uses: actions/download-artifact@v2
      with:
        name: builds-ubuntu-bionic-aarch64
        path: artifacts/ubuntu-bionic

    - name: Describe
      id: describe
      uses: edgedb/edgedb-pkg/integration/actions/describe-artifact@master
      with:
        target: ubuntu-bionic

    - name: Test Published
      uses: edgedb/edgedb-pkg/integration/linux/testpublished/ubuntu-bionic@master
      env:
        PKG_PLATFORM: "ubuntu"
        PKG_PLATFORM_VERSION: "bionic"
        PKG_INSTALL_REF: "${{ steps.describe.outputs.install-ref }}"
        PKG_VERSION_SLOT: "${{ steps.describe.outputs.version-slot }}"

    


  publish-ubuntu-focal-x86_64:
    needs: [test-ubuntu-focal-x86_64]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/download-artifact@v2
      with:
        name: builds-ubuntu-focal-x86_64
        path: artifacts/ubuntu-focal

    - name: Publish
      uses: edgedb/edgedb-pkg/integration/linux/upload/linux-x86_64@master
      env:
        PKG_PLATFORM: "ubuntu"
        PKG_PLATFORM_VERSION: "focal"
        PACKAGE_UPLOAD_SSH_KEY: "${{ secrets.PACKAGE_UPLOAD_SSH_KEY }}"

  check-published-ubuntu-focal-x86_64:
    needs: [publish-ubuntu-focal-x86_64]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/download-artifact@v2
      with:
        name: builds-ubuntu-focal-x86_64
        path: artifacts/ubuntu-focal

    - name: Describe
      id: describe
      uses: edgedb/edgedb-pkg/integration/actions/describe-artifact@master
      with:
        target: ubuntu-focal

    - name: Test Published
      uses: edgedb/edgedb-pkg/integration/linux/testpublished/ubuntu-focal@master
      env:
        PKG_PLATFORM: "ubuntu"
        PKG_PLATFORM_VERSION: "focal"
        PKG_INSTALL_REF: "${{ steps.describe.outputs.install-ref }}"
        PKG_VERSION_SLOT: "${{ steps.describe.outputs.version-slot }}"

    


  publish-ubuntu-focal-aarch64:
    needs: [test-ubuntu-focal-aarch64]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/download-artifact@v2
      with:
        name: builds-ubuntu-focal-aarch64
        path: artifacts/ubuntu-focal

    - name: Publish
      uses: edgedb/edgedb-pkg/integration/linux/upload/linux-x86_64@master
      env:
        PKG_PLATFORM: "ubuntu"
        PKG_PLATFORM_VERSION: "focal"
        PACKAGE_UPLOAD_SSH_KEY: "${{ secrets.PACKAGE_UPLOAD_SSH_KEY }}"

  check-published-ubuntu-focal-aarch64:
    needs: [publish-ubuntu-focal-aarch64]
    runs-on: ['self-hosted', 'linux', 'arm64']

    steps:
    - uses: actions/download-artifact@v2
      with:
        name: builds-ubuntu-focal-aarch64
        path: artifacts/ubuntu-focal

    - name: Describe
      id: describe
      uses: edgedb/edgedb-pkg/integration/actions/describe-artifact@master
      with:
        target: ubuntu-focal

    - name: Test Published
      uses: edgedb/edgedb-pkg/integration/linux/testpublished/ubuntu-focal@master
      env:
        PKG_PLATFORM: "ubuntu"
        PKG_PLATFORM_VERSION: "focal"
        PKG_INSTALL_REF: "${{ steps.describe.outputs.install-ref }}"
        PKG_VERSION_SLOT: "${{ steps.describe.outputs.version-slot }}"

    


  publish-ubuntu-jammy-x86_64:
    needs: [test-ubuntu-jammy-x86_64]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/download-artifact@v2
      with:
        name: builds-ubuntu-jammy-x86_64
        path: artifacts/ubuntu-jammy

    - name: Publish
      uses: edgedb/edgedb-pkg/integration/linux/upload/linux-x86_64@master
      env:
        PKG_PLATFORM: "ubuntu"
        PKG_PLATFORM_VERSION: "jammy"
        PACKAGE_UPLOAD_SSH_KEY: "${{ secrets.PACKAGE_UPLOAD_SSH_KEY }}"

  check-published-ubuntu-jammy-x86_64:
    needs: [publish-ubuntu-jammy-x86_64]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/download-artifact@v2
      with:
        name: builds-ubuntu-jammy-x86_64
        path: artifacts/ubuntu-jammy

    - name: Describe
      id: describe
      uses: edgedb/edgedb-pkg/integration/actions/describe-artifact@master
      with:
        target: ubuntu-jammy

    - name: Test Published
      uses: edgedb/edgedb-pkg/integration/linux/testpublished/ubuntu-jammy@master
      env:
        PKG_PLATFORM: "ubuntu"
        PKG_PLATFORM_VERSION: "jammy"
        PKG_INSTALL_REF: "${{ steps.describe.outputs.install-ref }}"
        PKG_VERSION_SLOT: "${{ steps.describe.outputs.version-slot }}"

    


  publish-ubuntu-jammy-aarch64:
    needs: [test-ubuntu-jammy-aarch64]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/download-artifact@v2
      with:
        name: builds-ubuntu-jammy-aarch64
        path: artifacts/ubuntu-jammy

    - name: Publish
      uses: edgedb/edgedb-pkg/integration/linux/upload/linux-x86_64@master
      env:
        PKG_PLATFORM: "ubuntu"
        PKG_PLATFORM_VERSION: "jammy"
        PACKAGE_UPLOAD_SSH_KEY: "${{ secrets.PACKAGE_UPLOAD_SSH_KEY }}"

  check-published-ubuntu-jammy-aarch64:
    needs: [publish-ubuntu-jammy-aarch64]
    runs-on: ['self-hosted', 'linux', 'arm64']

    steps:
    - uses: actions/download-artifact@v2
      with:
        name: builds-ubuntu-jammy-aarch64
        path: artifacts/ubuntu-jammy

    - name: Describe
      id: describe
      uses: edgedb/edgedb-pkg/integration/actions/describe-artifact@master
      with:
        target: ubuntu-jammy

    - name: Test Published
      uses: edgedb/edgedb-pkg/integration/linux/testpublished/ubuntu-jammy@master
      env:
        PKG_PLATFORM: "ubuntu"
        PKG_PLATFORM_VERSION: "jammy"
        PKG_INSTALL_REF: "${{ steps.describe.outputs.install-ref }}"
        PKG_VERSION_SLOT: "${{ steps.describe.outputs.version-slot }}"

    


  publish-centos-7-x86_64:
    needs: [test-centos-7-x86_64]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/download-artifact@v2
      with:
        name: builds-centos-7-x86_64
        path: artifacts/centos-7

    - name: Publish
      uses: edgedb/edgedb-pkg/integration/linux/upload/linux-x86_64@master
      env:
        PKG_PLATFORM: "centos"
        PKG_PLATFORM_VERSION: "7"
        PACKAGE_UPLOAD_SSH_KEY: "${{ secrets.PACKAGE_UPLOAD_SSH_KEY }}"

  check-published-centos-7-x86_64:
    needs: [publish-centos-7-x86_64]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/download-artifact@v2
      with:
        name: builds-centos-7-x86_64
        path: artifacts/centos-7

    - name: Describe
      id: describe
      uses: edgedb/edgedb-pkg/integration/actions/describe-artifact@master
      with:
        target: centos-7

    - name: Test Published
      uses: edgedb/edgedb-pkg/integration/linux/testpublished/centos-7@master
      env:
        PKG_PLATFORM: "centos"
        PKG_PLATFORM_VERSION: "7"
        PKG_INSTALL_REF: "${{ steps.describe.outputs.install-ref }}"
        PKG_VERSION_SLOT: "${{ steps.describe.outputs.version-slot }}"

    


  publish-centos-8-x86_64:
    needs: [test-centos-8-x86_64]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/download-artifact@v2
      with:
        name: builds-centos-8-x86_64
        path: artifacts/centos-8

    - name: Publish
      uses: edgedb/edgedb-pkg/integration/linux/upload/linux-x86_64@master
      env:
        PKG_PLATFORM: "centos"
        PKG_PLATFORM_VERSION: "8"
        PACKAGE_UPLOAD_SSH_KEY: "${{ secrets.PACKAGE_UPLOAD_SSH_KEY }}"

  check-published-centos-8-x86_64:
    needs: [publish-centos-8-x86_64]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/download-artifact@v2
      with:
        name: builds-centos-8-x86_64
        path: artifacts/centos-8

    - name: Describe
      id: describe
      uses: edgedb/edgedb-pkg/integration/actions/describe-artifact@master
      with:
        target: centos-8

    - name: Test Published
      uses: edgedb/edgedb-pkg/integration/linux/testpublished/centos-8@master
      env:
        PKG_PLATFORM: "centos"
        PKG_PLATFORM_VERSION: "8"
        PKG_INSTALL_REF: "${{ steps.describe.outputs.install-ref }}"
        PKG_VERSION_SLOT: "${{ steps.describe.outputs.version-slot }}"

    


  publish-centos-8-aarch64:
    needs: [test-centos-8-aarch64]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/download-artifact@v2
      with:
        name: builds-centos-8-aarch64
        path: artifacts/centos-8

    - name: Publish
      uses: edgedb/edgedb-pkg/integration/linux/upload/linux-x86_64@master
      env:
        PKG_PLATFORM: "centos"
        PKG_PLATFORM_VERSION: "8"
        PACKAGE_UPLOAD_SSH_KEY: "${{ secrets.PACKAGE_UPLOAD_SSH_KEY }}"

  check-published-centos-8-aarch64:
    needs: [publish-centos-8-aarch64]
    runs-on: ['self-hosted', 'linux', 'arm64']

    steps:
    - uses: actions/download-artifact@v2
      with:
        name: builds-centos-8-aarch64
        path: artifacts/centos-8

    - name: Describe
      id: describe
      uses: edgedb/edgedb-pkg/integration/actions/describe-artifact@master
      with:
        target: centos-8

    - name: Test Published
      uses: edgedb/edgedb-pkg/integration/linux/testpublished/centos-8@master
      env:
        PKG_PLATFORM: "centos"
        PKG_PLATFORM_VERSION: "8"
        PKG_INSTALL_REF: "${{ steps.describe.outputs.install-ref }}"
        PKG_VERSION_SLOT: "${{ steps.describe.outputs.version-slot }}"

    


  publish-linux-x86_64:
    needs: [test-linux-x86_64]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/download-artifact@v2
      with:
        name: builds-linux-x86_64
        path: artifacts/linux-x86_64

    - name: Publish
      uses: edgedb/edgedb-pkg/integration/linux/upload/linux-x86_64@master
      env:
        PKG_PLATFORM: "linux"
        PKG_PLATFORM_VERSION: "x86_64"
        PACKAGE_UPLOAD_SSH_KEY: "${{ secrets.PACKAGE_UPLOAD_SSH_KEY }}"

  check-published-linux-x86_64:
    needs: [publish-linux-x86_64]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/download-artifact@v2
      with:
        name: builds-linux-x86_64
        path: artifacts/linux-x86_64

    - name: Describe
      id: describe
      uses: edgedb/edgedb-pkg/integration/actions/describe-artifact@master
      with:
        target: linux-x86_64

    - name: Test Published
      uses: edgedb/edgedb-pkg/integration/linux/testpublished/linux-x86_64@master
      env:
        PKG_PLATFORM: "linux"
        PKG_PLATFORM_VERSION: "x86_64"
        PKG_INSTALL_REF: "${{ steps.describe.outputs.install-ref }}"
        PKG_VERSION_SLOT: "${{ steps.describe.outputs.version-slot }}"

    


  publish-linux-aarch64:
    needs: [test-linux-aarch64]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/download-artifact@v2
      with:
        name: builds-linux-aarch64
        path: artifacts/linux-aarch64

    - name: Publish
      uses: edgedb/edgedb-pkg/integration/linux/upload/linux-x86_64@master
      env:
        PKG_PLATFORM: "linux"
        PKG_PLATFORM_VERSION: "aarch64"
        PACKAGE_UPLOAD_SSH_KEY: "${{ secrets.PACKAGE_UPLOAD_SSH_KEY }}"

  check-published-linux-aarch64:
    needs: [publish-linux-aarch64]
    runs-on: ['self-hosted', 'linux', 'arm64']

    steps:
    - uses: actions/download-artifact@v2
      with:
        name: builds-linux-aarch64
        path: artifacts/linux-aarch64

    - name: Describe
      id: describe
      uses: edgedb/edgedb-pkg/integration/actions/describe-artifact@master
      with:
        target: linux-aarch64

    - name: Test Published
      uses: edgedb/edgedb-pkg/integration/linux/testpublished/linux-aarch64@master
      env:
        PKG_PLATFORM: "linux"
        PKG_PLATFORM_VERSION: "aarch64"
        PKG_INSTALL_REF: "${{ steps.describe.outputs.install-ref }}"
        PKG_VERSION_SLOT: "${{ steps.describe.outputs.version-slot }}"

    



  publish-macos-x86_64:
    needs: [test-macos-x86_64]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/download-artifact@v2
      with:
        name: builds-macos-x86_64
        path: artifacts/macos-x86_64

    - uses: actions/checkout@v2
      with:
        repository: edgedb/edgedb-pkg
        ref: master
        path: edgedb-pkg

    - name: Describe
      id: describe
      uses: edgedb/edgedb-pkg/integration/actions/describe-artifact@master
      with:
        target: macos-x86_64

    - name: Publish
      uses: edgedb/edgedb-pkg/integration/linux/upload/linux-x86_64@master
      env:
        PKG_PLATFORM: "macos"
        PKG_PLATFORM_VERSION: "x86_64"
        PACKAGE_UPLOAD_SSH_KEY: "${{ secrets.PACKAGE_UPLOAD_SSH_KEY }}"


  publish-macos-aarch64:
    needs: [test-macos-aarch64]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/download-artifact@v2
      with:
        name: builds-macos-aarch64
        path: artifacts/macos-aarch64

    - uses: actions/checkout@v2
      with:
        repository: edgedb/edgedb-pkg
        ref: master
        path: edgedb-pkg

    - name: Describe
      id: describe
      uses: edgedb/edgedb-pkg/integration/actions/describe-artifact@master
      with:
        target: macos-aarch64

    - name: Publish
      uses: edgedb/edgedb-pkg/integration/linux/upload/linux-x86_64@master
      env:
        PKG_PLATFORM: "macos"
        PKG_PLATFORM_VERSION: "aarch64"
        PACKAGE_UPLOAD_SSH_KEY: "${{ secrets.PACKAGE_UPLOAD_SSH_KEY }}"

